## volatile

volatile 在多处理器开发中保证了共享变量的”可见性“。可见性的意思是当一个线程修改了一个共享变量时，另外一个线程能读到这个修改的值。

我的理解是，因为每个线程都把共享变量从内存中 copy 了一份到自己的缓存中，原来各个线程在自己的缓存修改了共享变量，但是可能短时间内不会写回内存，这就导致了各个线程都不知道对方对共享变量进行了修改，“可见性”的意思是说就能“看到”这个修改。而 volatile 修饰后的共享变量，它能够在缓存中修改了值后，及时写回内存，这样其他线程就能在内存中获取修改后的值。

有一个说法是：volatile 是禁用缓存以及编译优化。

volatile 的两条实现原则：

- Lock 前缀指令（这是 volatile 变量修饰的共享变量进行写操作的时候转变成汇编代码出现的）会引起处理器缓存写回内存。
- 一个处理器的缓存回写到内存会导致其他处理器的缓存无效。

### Happens-Before 规则

> 前面一个操作的结果对后续操作是可见的。

volatile 变量规则：对一个 volatile 变量的写操作，Happens-Before 于后续对这个 volatile 变量的读操作。

程序的顺序性规则：按照程序顺序，前面的操作 Happens-Before 于后续的任意操作。

传递性：若 A Happens-Before B，B Happens-Before C，则 A Happens-Before C。

管程中锁的规则：对一个锁的解锁 Happens-Before 于后续对这个锁的加锁。

